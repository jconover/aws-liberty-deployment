# Monitoring stack variables

# Prometheus settings
prometheus_version: "2.48.1"
prometheus_port: 9090
prometheus_retention: "{{ prometheus_retention | default('15d') }}"
prometheus_data_dir: /var/lib/prometheus
prometheus_config_dir: /etc/prometheus

prometheus_global_config:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s

prometheus_alertmanager_config:
  - static_configs:
    - targets:
      - "localhost:9093"

# Grafana settings
grafana_version: "10.2.3"
grafana_port: 3000
grafana_data_dir: /var/lib/grafana
grafana_admin_user: admin
grafana_admin_password: "{{ vault_grafana_admin_password | default('admin') }}"

grafana_datasources:
  - name: Prometheus
    type: prometheus
    url: "http://localhost:{{ prometheus_port }}"
    isDefault: true
    access: proxy

# Alertmanager settings
alertmanager_version: "0.26.0"
alertmanager_port: 9093
alertmanager_data_dir: /var/lib/alertmanager
alertmanager_config_dir: /etc/alertmanager

# Alert routing (customize for your environment)
alertmanager_route:
  group_by:
    - alertname
    - severity
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: default
  routes:
    - match:
        severity: critical
      receiver: critical-alerts
      continue: true
    - match:
        severity: warning
      receiver: warning-alerts

# Alert receivers
alertmanager_receivers:
  - name: default
    email_configs: []
  - name: critical-alerts
    email_configs:
      - to: "{{ alert_email | default('alerts@example.com') }}"
        from: "prometheus@example.com"
        smarthost: "smtp.example.com:587"
        auth_username: "{{ vault_smtp_user | default('') }}"
        auth_password: "{{ vault_smtp_password | default('') }}"
  - name: warning-alerts
    email_configs: []

# Alert rules
prometheus_alert_rules:
  - name: node_alerts
    rules:
      - alert: HighCpuUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "CPU usage is above 80% for more than 5 minutes."

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Memory usage is above 85% for more than 5 minutes."

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Disk space is below 15%."

      - alert: InstanceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ '{{' }} $labels.instance {{ '}}' }} is down"
          description: "The instance has been unreachable for more than 2 minutes."

  - name: liberty_alerts
    rules:
      - alert: LibertyServerDown
        expr: liberty_server_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Liberty server is down on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Liberty server has been down for more than 1 minute."

      - alert: LibertyHighRequestLatency
        expr: rate(liberty_servlet_request_duration_seconds_sum[5m]) / rate(liberty_servlet_request_duration_seconds_count[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Average request latency is above 1 second."

      - alert: LibertyHighErrorRate
        expr: rate(liberty_servlet_request_total{status=~"5.."}[5m]) / rate(liberty_servlet_request_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Error rate is above 5%."

      - alert: LibertyHeapMemoryHigh
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High heap memory usage on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "JVM heap memory usage is above 85%."

# Prometheus scrape targets (dynamically populated)
prometheus_scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets:
          - "localhost:{{ prometheus_port }}"

  - job_name: node
    ec2_sd_configs:
      - region: "{{ aws_region }}"
        port: 9100
        filters:
          - name: "tag:Project"
            values:
              - "{{ project_name }}"
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance
      - source_labels: [__meta_ec2_tag_Role]
        target_label: role
      - source_labels: [__meta_ec2_tag_Environment]
        target_label: environment

  - job_name: liberty
    ec2_sd_configs:
      - region: "{{ aws_region }}"
        port: 9545
        filters:
          - name: "tag:Role"
            values:
              - liberty
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance
      - source_labels: [__meta_ec2_tag_Environment]
        target_label: environment
